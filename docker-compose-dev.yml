---
services:
  # -------------------------
  # Shared nginx
  # -------------------------
  www:
    container_name: tools_www
    image: ghcr.io/nginx/nginx-unprivileged:stable
    restart: always
    ports:
      - "8080:8080"
    networks:
      - backend
    volumes:
      - "./nginx/html/:/usr/share/nginx/html/:ro"
      - "./nginx/conf.d/:/etc/nginx/conf.d/"
      - "tools_homepage:/var/www/html/homepage:ro"
      - "tools_taboo:/var/www/html/taboo:ro"
      - "tools_unit-converter:/var/www/html/unit-converter:ro"
      - "tools_yaml-formatter:/var/www/html/yaml-formatter:ro"
      - "tools_ocr:/var/www/html/ocr:ro"
      - "tools_emoji-identifier:/var/www/html/emoji-identifier:ro"
      - "tools_exiftools:/var/www/html/exiftools:ro"
      - "tools_ghissue2md:/var/www/html/ghissue2md:ro"
      - "tools_graphviz-visualizer:/var/www/html/graphviz-visualizer:ro"
      - "tools_link-extractor:/var/www/html/link-extractor:ro"
      - "tools_qr:/var/www/html/qr:ro"
      - "tools_render-markdown:/var/www/html/render-markdown:ro"
      - "tools_bingo-creator:/var/www/html/bingo-creator:ro"
      - "tools_json-utils:/var/www/html/json-utils:ro"
      - "tools_matter:/var/www/html/matter:ro"
      - "tools_tfps:/var/www/html/tfps:ro"
      - "tools_anki-converter:/var/www/html/anki-converter:ro"

  # -------------------------
  # Runtime apps
  # -------------------------
  clip2gist:
    container_name: tools_clip2gist
    build:
      context: ./apps/clip2gist
      dockerfile: Dockerfile
    image: tools_clip2gist:latest
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/clip2gist/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    env_file: ./apps/clip2gist/app.env
    networks:
      - backend

  gh-dashboard:
    container_name: tools_gh-dashboard
    build:
      context: ./apps/gh-dashboard
      dockerfile: Dockerfile
    image: tools_gh-dashboard:latest
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/gh-dashboard/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    env_file: ./apps/gh-dashboard/app.env
    networks:
      - backend

  www2s:
    container_name: tools_www2s
    build:
      context: ./apps/www2s
      dockerfile: Dockerfile
    image: tools_www2s:latest
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/www2s/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    env_file: ./apps/www2s/app.env
    networks:
      - backend

  www2epub:
    container_name: tools_www2epub
    build:
      context: ./apps/www2epub
      dockerfile: Dockerfile
    image: tools_www2epub:latest
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/www2epub/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - backend

  # -------------------------
  # Builder services
  # -------------------------
  homepage:
    container_name: tools_homepage
    profiles: ["build"]
    build:
      context: ./apps/homepage
      dockerfile: Dockerfile
    image: tools_homepage:latest
    volumes:
      - tools_homepage:/app/out
    command: ["sleep", "5"]

  taboo:
    container_name: tools_taboo
    profiles: ["build"]
    build:
      context: ./apps/taboo
      dockerfile: Dockerfile
    image: tools_taboo:latest
    volumes:
      - tools_taboo:/app/out
    command: ["sleep", "5"]

  unit-converter:
    container_name: tools_unit-converter
    profiles: ["build"]
    build:
      context: ./apps/unit-converter
      dockerfile: Dockerfile
    image: tools_unit-converter:latest
    volumes:
      - tools_unit-converter:/app/out
    command: ["sleep", "5"]

  yaml-formatter:
    container_name: tools_yaml-formatter
    profiles: ["build"]
    build:
      context: ./apps/yaml-formatter
      dockerfile: Dockerfile
    image: tools_yaml-formatter:latest
    volumes:
      - tools_yaml-formatter:/app/out
    command: ["sleep", "5"]

  ocr:
    container_name: tools_ocr
    profiles: ["build"]
    build:
      context: ./apps/ocr
      dockerfile: Dockerfile
    image: tools_ocr:latest
    volumes:
      - tools_ocr:/app/out
    command: ["sleep", "5"]

  emoji-identifier:
    container_name: tools_emoji-identifier
    profiles: ["build"]
    build:
      context: ./apps/emoji-identifier
      dockerfile: Dockerfile
    image: tools_emoji-identifier:latest
    volumes:
      - tools_emoji-identifier:/app/out
    command: ["sleep", "5"]

  exiftools:
    container_name: tools_exiftools
    profiles: ["build"]
    build:
      context: ./apps/exiftools
      dockerfile: Dockerfile
    image: tools_exiftools:latest
    volumes:
      - tools_exiftools:/app/out
    command: ["sleep", "5"]

  ghissue2md:
    container_name: tools_ghissue2md
    profiles: ["build"]
    build:
      context: ./apps/ghissue2md
      dockerfile: Dockerfile
    image: tools_ghissue2md:latest
    volumes:
      - tools_ghissue2md:/app/out
    command: ["sleep", "5"]

  graphviz-visualizer:
    container_name: tools_graphviz-visualizer
    profiles: ["build"]
    build:
      context: ./apps/graphviz-visualizer
      dockerfile: Dockerfile
    image: tools_graphviz-visualizer:latest
    volumes:
      - tools_graphviz-visualizer:/app/out
    command: ["sleep", "5"]

  link-extractor:
    container_name: tools_link-extractor
    profiles: ["build"]
    build:
      context: ./apps/link-extractor
      dockerfile: Dockerfile
    image: tools_link-extractor:latest
    volumes:
      - tools_link-extractor:/app/out
    command: ["sleep", "5"]

  qr:
    container_name: tools_qr
    profiles: ["build"]
    build:
      context: ./apps/qr
      dockerfile: Dockerfile
    image: tools_qr:latest
    volumes:
      - tools_qr:/app/out
    command: ["sleep", "5"]

  render-markdown:
    container_name: tools_render-markdown
    profiles: ["build"]
    build:
      context: ./apps/render-markdown
      dockerfile: Dockerfile
    image: tools_render-markdown:latest
    volumes:
      - tools_render-markdown:/app/out
    command: ["sleep", "5"]

  bingo-creator:
    container_name: tools_bingo-creator
    profiles: ["build"]
    build:
      context: ./apps/bingo-creator
      dockerfile: Dockerfile
    image: tools_bingo-creator:latest
    volumes:
      - tools_bingo-creator:/app/out
    command: ["sleep", "5"]

  json-utils:
    container_name: tools_json-utils
    profiles: ["build"]
    build:
      context: ./apps/json-utils
      dockerfile: Dockerfile
    image: tools_json-utils:latest
    volumes:
      - tools_json-utils:/app/out
    command: ["sleep", "5"]

  matter:
    container_name: tools_matter
    profiles: ["build"]
    build:
      context: ./apps/matter
      dockerfile: Dockerfile
    image: tools_matter:latest
    volumes:
      - tools_matter:/app/out
    command: ["sleep", "5"]

  tfps:
    container_name: tools_tfps
    profiles: ["build"]
    build:
      context: ./apps/tfps
      dockerfile: Dockerfile
    image: tools_tfps:latest
    volumes:
      - tools_tfps:/app/out
    command: ["sleep", "5"]

  anki-converter:
    container_name: tools_anki-converter
    profiles: ["build"]
    build:
      context: ./apps/anki-converter
      dockerfile: Dockerfile
    image: tools_anki-converter:latest
    volumes:
      - tools_anki-converter:/app/out
    command: ["sleep", "5"]

volumes:
  tools_homepage:
  tools_taboo:
  tools_unit-converter:
  tools_yaml-formatter:
  tools_ocr:
  tools_emoji-identifier:
  tools_exiftools:
  tools_ghissue2md:
  tools_graphviz-visualizer:
  tools_link-extractor:
  tools_qr:
  tools_render-markdown:
  tools_bingo-creator:
  tools_json-utils:
  tools_matter:
  tools_tfps:
  tools_anki-converter:

networks:
  backend:
    driver: bridge
