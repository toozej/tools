---
name: release

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 18 * * 0"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  discover-apps:
    runs-on: ubuntu-24.04
    outputs:
      apps: ${{ steps.discover.outputs.apps }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get list of apps to build
        id: discover
        run: |
          # Find all services in docker-compose that have a build context and runtime profile
          # Extract app name from build.context (e.g., ./apps/homepage -> homepage)
          apps=$(yq -r '.services | to_entries[] | select(.value.build != null and .value.profiles != null and ((.value.profiles | contains(["build"])) or (.value.profiles | contains(["runtime"])))) | .value.build.context | sub("^\\./apps/", "")' docker-compose-dev.yml | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "apps=$apps" >> "$GITHUB_OUTPUT"
          echo "Found apps: $apps"

  build-and-push:
    runs-on: ubuntu-24.04
    needs: discover-apps
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        apps: ${{ fromJson(needs.discover-apps.outputs.apps) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ matrix.apps }}
            type=raw,value=${{ matrix.apps }}-main

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/${{ matrix.apps }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64
          build-args: |
            RELEASE=true
            APP=${{ matrix.apps }}
            TARGETPLATFORM=linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max

  trivy-scan-image-amd64:
    name: trivy-scan-image
    needs: [discover-apps, build-and-push]
    runs-on: ubuntu-24.04
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        apps: ${{ fromJson(needs.discover-apps.outputs.apps) }}
        platform: [linux/amd64]
    steps: &scan-image-steps
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.apps }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  trivy-scan-image-arm64:
    name: trivy-scan-image
    needs: [discover-apps, build-and-push]
    runs-on: ubuntu-24.04-arm
    permissions:
      packages: read
    strategy:
      fail-fast: false
      matrix:
        apps: ${{ fromJson(needs.discover-apps.outputs.apps) }}
        platform: [linux/arm64]
    steps: *scan-image-steps
