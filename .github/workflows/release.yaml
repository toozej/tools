---
name: release

on:
  push:
    branches:
      - main
  schedule:
    - cron: "0 18 * * 0"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  discover-apps:
    runs-on: ubuntu-24.04
    outputs:
      apps: ${{ steps.discover.outputs.apps }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Get list of apps to build
        id: discover
        run: |
          # Find all services in docker-compose that have a build context and runtime profile
          # Extract app name from build.context (e.g., ./apps/homepage -> homepage)
          apps=$(yq -r '.services | to_entries[] | select(.value.build != null and .value.profiles != null and ((.value.profiles | contains(["build"])) or (.value.profiles | contains(["runtime"])))) | .value.build.context | sub("^\\./apps/", "")' docker-compose-dev.yml | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "apps=$apps" >> "$GITHUB_OUTPUT"
          echo "Found apps: $apps"

  build-and-push-amd64:
    runs-on: ubuntu-24.04
    needs: discover-apps
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        apps: ${{ fromJson(needs.discover-apps.outputs.apps) }}
        platform: [linux/amd64]

    steps: &build-steps
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=${{ matrix.apps }}-main
            type=raw,value=${{ matrix.apps }}

      - name: Build and push Docker image
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 300
          retry_on: error
          shell: bash
          command: |
            # Build tag arguments
            tag_args=""
            while IFS= read -r tag; do
              [ -n "$tag" ] && tag_args="$tag_args --tag $tag"
            done <<< "${{ steps.meta.outputs.tags }}"

            # Build label arguments
            label_args=""
            while IFS= read -r label; do
              [ -n "$label" ] && label_args="$label_args --label $label"
            done <<< "${{ steps.meta.outputs.labels }}"

            docker buildx build \
              ./apps/${{ matrix.apps }} \
              --push \
              $tag_args \
              $label_args \
              --platform ${{ matrix.platform }} \
              --build-arg RELEASE=true \
              --build-arg APP=${{ matrix.apps }} \
              --build-arg TARGETPLATFORM=${{ matrix.platform }} \
              --cache-from type=gha \
              --cache-to type=gha,mode=max

  trivy-scan-image-amd64:
    name: trivy-scan-image
    needs: [discover-apps, build-and-push-amd64]
    runs-on: ubuntu-24.04
    permissions:
      packages: read
    strategy:
      matrix:
        apps: ${{ fromJson(needs.discover-apps.outputs.apps) }}
        platform: [linux/amd64]
    steps: &scan-image-steps
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ matrix.apps }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'


  build-and-push-arm64:
    runs-on: ubuntu-24.04-arm
    needs: discover-apps
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        apps: ${{ fromJson(needs.discover-apps.outputs.apps) }}
        platform: [linux/arm64]
    steps: *build-steps

  trivy-scan-image-arm64:
    name: trivy-scan-image
    needs: [discover-apps, build-and-push-arm64]
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        apps: ${{ fromJson(needs.discover-apps.outputs.apps) }}
        platform: [linux/arm64]
    steps: *scan-image-steps
