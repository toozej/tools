---
services:
  www:
    container_name: tools_www
    image: ghcr.io/nginx/nginx-unprivileged:stable
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      clip2gist:
        condition: service_healthy
      gh-dashboard:
        condition: service_healthy
      www2s:
        condition: service_healthy
      www2epub:
        condition: service_healthy
      homepage:
        condition: service_started
      taboo:
        condition: service_started
      unit-converter:
        condition: service_started
      yaml-formatter:
        condition: service_started
      ocr:
        condition: service_started
      emoji-identifier:
        condition: service_started
      exiftools:
        condition: service_started
      ghissue2md:
        condition: service_started
      graphviz-visualizer:
        condition: service_started
      link-extractor:
        condition: service_started
      qr:
        condition: service_started
      render-markdown:
        condition: service_started
      bingo-creator:
        condition: service_started
      json-utils:
        condition: service_started
      matter:
        condition: service_started
      tfps:
        condition: service_started
      anki-converter:
        condition: service_started
    networks:
      - backend
    volumes:
      - "./nginx/html/:/usr/share/nginx/html/:ro"
      - "./nginx/conf.d/:/etc/nginx/conf.d/"
      - "tools_homepage:/var/www/html/homepage:ro"
      - "tools_taboo:/var/www/html/taboo:ro"
      - "tools_unit-converter:/var/www/html/unit-converter:ro"
      - "tools_yaml-formatter:/var/www/html/yaml-formatter:ro"
      - "tools_ocr:/var/www/html/ocr:ro"
      - "tools_emoji-identifier:/var/www/html/emoji-identifier:ro"
      - "tools_exiftools:/var/www/html/exiftools:ro"
      - "tools_ghissue2md:/var/www/html/ghissue2md:ro"
      - "tools_graphviz-visualizer:/var/www/html/graphviz-visualizer:ro"
      - "tools_link-extractor:/var/www/html/link-extractor:ro"
      - "tools_qr:/var/www/html/qr:ro"
      - "tools_render-markdown:/var/www/html/render-markdown:ro"
      - "tools_bingo-creator:/var/www/html/bingo-creator:ro"
      - "tools_json-utils:/var/www/html/json-utils:ro"
      - "tools_matter:/var/www/html/matter:ro"
      - "tools_tfps:/var/www/html/tfps:ro"
      - "tools_anki-converter:/var/www/html/anki-converter:ro"

  # -------------------------
  # Runtime apps
  # -------------------------
  clip2gist:
    container_name: tools_clip2gist
    image: ghcr.io/toozej/tools:clip2gist
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/clip2gist/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    env_file: ./apps/clip2gist/app.env
    networks:
      - backend

  gh-dashboard:
    container_name: tools_gh-dashboard
    image: ghcr.io/toozej/tools:gh-dashboard
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/gh-dashboard/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    env_file: ./apps/gh-dashboard/app.env
    networks:
      - backend

  www2s:
    container_name: tools_www2s
    image: ghcr.io/toozej/tools:www2s
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/www2s/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    env_file: ./apps/www2s/app.env
    networks:
      - backend

  www2epub:
    container_name: tools_www2epub
    image: ghcr.io/toozej/tools:www2epub
    restart: always
    profiles: ["runtime"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/www2epub/api/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - backend

  # -------------------------
  # Builder services
  # -------------------------
  homepage:
    container_name: tools_homepage
    profiles: ["build"]
    image: ghcr.io/toozej/tools:homepage
    volumes:
      - tools_homepage:/app/out
    command: ["sleep", "5"]

  taboo:
    container_name: tools_taboo
    profiles: ["build"]
    image: ghcr.io/toozej/tools:taboo
    volumes:
      - tools_taboo:/app/out
    command: ["sleep", "5"]

  unit-converter:
    container_name: tools_unit-converter
    profiles: ["build"]
    image: ghcr.io/toozej/tools:unit-converter
    volumes:
      - tools_unit-converter:/app/out
    command: ["sleep", "5"]

  yaml-formatter:
    container_name: tools_yaml-formatter
    profiles: ["build"]
    image: ghcr.io/toozej/tools:yaml-formatter
    volumes:
      - tools_yaml-formatter:/app/out
    command: ["sleep", "5"]

  ocr:
    container_name: tools_ocr
    profiles: ["build"]
    image: ghcr.io/toozej/tools:ocr
    volumes:
      - tools_ocr:/app/out
    command: ["sleep", "5"]

  emoji-identifier:
    container_name: tools_emoji-identifier
    profiles: ["build"]
    image: ghcr.io/toozej/tools:emoji-identifier
    volumes:
      - tools_emoji-identifier:/app/out
    command: ["sleep", "5"]

  exiftools:
    container_name: tools_exiftools
    profiles: ["build"]
    image: ghcr.io/toozej/tools:exiftools
    volumes:
      - tools_exiftools:/app/out
    command: ["sleep", "5"]

  ghissue2md:
    container_name: tools_ghissue2md
    profiles: ["build"]
    image: ghcr.io/toozej/tools:ghissue2md
    volumes:
      - tools_ghissue2md:/app/out
    command: ["sleep", "5"]

  graphviz-visualizer:
    container_name: tools_graphviz-visualizer
    profiles: ["build"]
    image: ghcr.io/toozej/tools:graphviz-visualizer
    volumes:
      - tools_graphviz-visualizer:/app/out
    command: ["sleep", "5"]

  link-extractor:
    container_name: tools_link-extractor
    profiles: ["build"]
    image: ghcr.io/toozej/tools:link-extractor
    volumes:
      - tools_link-extractor:/app/out
    command: ["sleep", "5"]

  qr:
    container_name: tools_qr
    profiles: ["build"]
    image: ghcr.io/toozej/tools:qr
    volumes:
      - tools_qr:/app/out
    command: ["sleep", "5"]

  render-markdown:
    container_name: tools_render-markdown
    profiles: ["build"]
    image: ghcr.io/toozej/tools:render-markdown
    volumes:
      - tools_render-markdown:/app/out
    command: ["sleep", "5"]

  bingo-creator:
    container_name: tools_bingo-creator
    profiles: ["build"]
    image: ghcr.io/toozej/tools:bingo-creator
    volumes:
      - tools_bingo-creator:/app/out
    command: ["sleep", "5"]

  json-utils:
    container_name: tools_json-utils
    profiles: ["build"]
    image: ghcr.io/toozej/tools:json-utils
    volumes:
      - tools_json-utils:/app/out
    command: ["sleep", "5"]

  matter:
    container_name: tools_matter
    profiles: ["build"]
    image: ghcr.io/toozej/tools:matter
    volumes:
      - tools_matter:/app/out
    command: ["sleep", "5"]

  tfps:
    container_name: tools_tfps
    profiles: ["build"]
    image: ghcr.io/toozej/tools:tfps
    volumes:
      - tools_tfps:/app/out
    command: ["sleep", "5"]

  anki-converter:
    container_name: tools_anki-converter
    profiles: ["build"]
    image: ghcr.io/toozej/tools:anki-converter
    volumes:
      - tools_anki-converter:/app/out
    command: ["sleep", "5"]

volumes:
  tools_homepage:
  tools_taboo:
  tools_unit-converter:
  tools_yaml-formatter:
  tools_ocr:
  tools_emoji-identifier:
  tools_exiftools:
  tools_ghissue2md:
  tools_graphviz-visualizer:
  tools_link-extractor:
  tools_qr:
  tools_render-markdown:
  tools_bingo-creator:
  tools_json-utils:
  tools_matter:
  tools_tfps:
  tools_anki-converter:

networks:
  backend:
    driver: bridge
